---
title: "Effect of stay-at-home order on Covid-19 infectious population growth rate in 5 European countries: France, Germany, UK, Italy, and Poland"
author: "Team 2: Zeng Fung Liew (913802324), Yixing Lu (915501254), Liela Meng (917843295), Apurv Srivastav (918936075)"
date: "March 5th, 2021"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo=FALSE, warning=FALSE, message=FALSE)
```

```{r, include=FALSE}
library(tidyverse)
# load data 
covid <- read_csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")
covid[which(covid$Country == "The United Kingdom"), "Country"] = "UK"

# filter out countries in "Other" WHO regions
covid <- covid %>% 
  filter(WHO_region != "Other") %>% 
  mutate(WHO_region = fct_recode(WHO_region,
                                 "Eastern Mediterranean"="EMRO",
                                 "Europe" = "EURO",
                                 "Africa" = "AFRO",
                                 "Western Pacific" = "WPRO",
                                 "Americas"="AMRO",
                                 "South-East Asia" = "SEARO"))

# stay-at-home dataset
home = read_csv("../stay-at-home-covid.csv")             # change filename/directory if necessary
home$stay_home_requirements = as.factor(home$stay_home_requirements)
home[which(home$Entity == "United Kingdom"), "Entity"] = "UK"

# inner join data
covid = inner_join(covid, home, 
                     by = c("Date_reported" = "Date",
                            "Country" = "Entity"),
                     keep = FALSE)
covid = covid[, c("Date_reported", 
                  "Country_code", 
                  "Country", 
                  "WHO_region", 
                  "New_cases", 
                  "Cumulative_cases", 
                  "New_deaths", 
                  "Cumulative_deaths", 
                  "stay_home_requirements")]

# Target period of analysis: 2020-10-01 to 2020-11-30
# Target country: Germany, UK, France, Italy, Poland
covid_window <- covid %>% 
  filter(Country %in% c("Germany", "UK", "France", "Italy", "Poland") & 
           Date_reported>"2020-08-15" & 
           Date_reported<"2020-12-07")

# virus incubation period d = 7
# I_(t-d-1) = y_(t-1) - y_(t-d-1), where y is cumulative cases
# delta_I_t = [y_t - y_(t-d)] - [y_(t-1)-y_(t-d-1)] = new_cases_t - new_cases_(t-d)
covid_model.d7 <- covid_window %>% 
  group_by(Country) %>% 
  mutate(New_infectious = New_cases - lag(New_cases,7),
         lag_infectious = Cumulative_cases - lag(Cumulative_cases,7))

# change in stay home restriction
covid_model.d7 <- covid_model.d7 %>%
  group_by(Country) %>%
  mutate(stay_home_diff_07 = as.factor(as.numeric(stay_home_requirements) - lag(as.numeric(stay_home_requirements), 7)),
         stay_home_diff_05 = as.factor(as.numeric(stay_home_requirements) - lag(as.numeric(stay_home_requirements), 5)),
         stay_home_diff_03 = as.factor(as.numeric(stay_home_requirements) - lag(as.numeric(stay_home_requirements), 3))
  )

# lagged change in stay home restriction
covid_model.d7 <- covid_model.d7 %>%
  group_by(Country) %>%
  mutate(lag_stay_home = lag(stay_home_requirements, 14),
         lag_stay_home_diff_07 = as.factor(lag(as.numeric(stay_home_requirements), 14) -
                                         lag(as.numeric(stay_home_requirements), 21)),
         lag_stay_home_diff_05 = as.factor(lag(as.numeric(stay_home_requirements), 14) -
                                         lag(as.numeric(stay_home_requirements), 19)),
         lag_stay_home_diff_03 = as.factor(lag(as.numeric(stay_home_requirements), 14) -
                                         lag(as.numeric(stay_home_requirements), 17)),
         lag_stay_home_diff_01 = as.factor(lag(as.numeric(stay_home_requirements), 14) -
                                         lag(as.numeric(stay_home_requirements), 15))
  )

# calculating 3, 5, 7-day moving average of new_infectious and cum_infectious
covid_model.d7 <- covid_model.d7 %>% 
  group_by(Country) %>% 
  mutate(New_infec_07ma = zoo:: rollmean(New_infectious,k=7,fill=NA),
         lag_infec_07ma = zoo:: rollmean(lag_infectious,k=7,fill=NA),
         New_infec_05ma = zoo:: rollmean(New_infectious,k=5,fill=NA),
         lag_infec_05ma = zoo:: rollmean(lag_infectious,k=5,fill=NA),
         New_infec_03ma = zoo:: rollmean(New_infectious,k=3,fill=NA),
         lag_infec_03ma = zoo:: rollmean(lag_infectious,k=3,fill=NA)) %>%
  dplyr::ungroup()

covid_model.d7 <- covid_model.d7 %>% 
  filter(covid_model.d7$Date_reported>"2020-09-30" & 
           covid_model.d7$Date_reported<"2020-12-01")
range(covid_model.d7$Date_reported) # 2020-10-01 to 2020-11-30

# Calculate response variable: delta_infectious
covid_model.d7 <- covid_model.d7 %>% 
  mutate(delta_infectious = 100*New_infectious/lag_infectious, 
         delta_infec_07ma = 100*New_infec_07ma/lag_infec_07ma, 
         delta_infec_05ma = 100*New_infec_05ma/lag_infec_05ma, 
         delta_infec_03ma = 100*New_infec_03ma/lag_infec_03ma,
         lag_delta_infec_07ma = lag(delta_infec_07ma, 14))

# plot of delta_infectious vs. date
plot(covid_model.d7$Date_reported,covid_model.d7$delta_infec_05ma, 
     type="p",cex=0.3,
     main = expression(paste("%", Delta, y[ct], " by Date")),
     xlab = "Date",
     ylab = expression(paste("%", Delta, y[ct])))
```

# Abstract 



# Introduction


 
# Background 



# Descriptive analysis 
The summary statistics should include at least time, number of cases, number of death, case-mortality rate.

# Inferential analysis

To find out whether the change in level of stay-home restriction has an impact on the rate of growth in active infections, we fit a panel regression model as follows:
$$
\Delta y_{ct} = \alpha_c + \alpha_t + \beta_{1,1} x_{1,1,ct} + \beta_{1,2} x_{1,2,ct} + \beta_{2,-1} x_{2,-1,ct} + \beta_{2,1} x_{2,1,ct} + \beta_{2,2} x_{2,2,ct} + u_{ct}
$$
where 

(1) $\Delta y_{ct}$ is the change in rate of active infections for country $c$ at time $t$, which is calculated using 

$$
\Delta y_{ct} = \frac{(y_{ct} - y_{c(t-7)}) - (y_{c(t-1)} - y_{c(t-8)})}{y_{c(t-1)} - y_{c(t-8)}}
$$
where $y_{ct}$ is the number of new cases for country $c$ at time $t$.

(2) $\alpha_c$ is the country-level fixed effect, ie. $c = \{$France, Germany, UK, Poland, Italy$\}$.

(3) $\alpha_t$ is the time-level fixed effect, ie. the dates reported for this data analysis, $t = \{10/01/2020, \ldots, 11/30/2020\}$.

(4) $x_{1,i,ct}$ is the stay-home requirement level for country $c$ at 14 days prior to time $t$, ie. $i = \{0,1,2\}$. Since $x_{1,ct}$ is represented as dummy variables, the case for $x_{1,0,ct}$ is implied by the model when $x_{1,1,ct} = x_{1,2,ct} = 0$.

(5) $x_{2,j,ct}$ is the change in stay-home requirement for country $c$ at the previous week of (4). This is computed as follows:
$$
x_{2,j,ct} = \mathbb{1}_{\{x_{1,i,ct} - x_{1,i',c(t-7)}\}} \ {\rm for } \ i,i' = \{0,1,2\}, j = \{-1, 0, 1, 2\} 
$$
Since $x_{2,ct}$ is represented as dummy variables, the case for $x_{2,0,ct}$ is implied by the model when $x_{2,1,ct} = x_{2,2,ct} = x_{2,-1,ct} = 0$.

(6) $u_{ct}$ is the error for country $c$ at time $t$.

This model comes with a few advantages. The fixed effect $\alpha_c$ controls the time-invariant effect of countries which can impact the change in rate of active infections for each country, eg. weather, socioeconomy status, local health care system, and population size [1]. The fixed effect $\alpha_t$ controls the factors that vary over time. As discussed by Fowler et al., this includes the changes in testing availability, national policies that vary over time, and the occurence of major events that impacts social behaviors of people in the country. However, the panel regression model also comes with some strict assumptions. These assumptions and diagnostics are tested and discussed under the Sensitivity Analysis section.

The fitted model gives us the following estimates:
```{r}
library(plm)
model = plm(delta_infec_07ma ~ lag_stay_home + lag_stay_home_diff_07 +lag_delta_infec_07ma, data = covid_model.d7,
                index = c("Country", "Date_reported"), model = "within")
summary(model)
fixef(model)
```
## Lagged effect of stay-at-home order 

## Effect of policy strictness on infectious population growth rate

# Sensitivity analysis 

## Lagged effect of stay-at-home order 

## Effect of policy strictness on infectious population growth rate


# Causal interpretation 


# Discussion 


# Acknowledgement {-}


# Reference {-}


# Session info {-}

<span style='color:blue'>
Report information of your `R` session for reproducibility. 
</span> 


```{r}
sessionInfo()
```

---
title: "Effect of stay-at-home order on Covid-19 infectious population growth rate"
subtitle: "Analysis of 5 European countries: France, Germany, UK, Italy, and Poland during October and November, 2020"
author: "Team 2: Zeng Fung Liew (913802324), Yixing Lu (915501254), Liela Meng (917843295), Apurv Srivastav (918936075)"
date: "March 5th, 2021"
output:
  html_document:
    df_print: paged
    number_sections: yes
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Abstract 



# Introduction


 
# Background 



# Descriptive analysis 
The summary statistics should include at least time, number of cases, number of death, case-mortality rate.

# Inferential analysis 

## Lagged effect of stay-at-home order 

```{r set up, include = FALSE}
library(tidyverse)
library(dplyr)
library(zoo)
library(ggplot2)
library(plotly)
library(plm)
library(knitr)
library(broom)
# import data
# covid data
setwd('..')
covid_model.d7 = read.csv("./data/who_new_response.csv", header = TRUE)
# stay-at-home data
home = read_csv("data/stay-at-home-covid.csv")  
```
```{r pre-processing}
# data pre-processing
# filter data
home <- home %>% filter(Entity %in% c("Germany", "United Kingdom", "France", "Italy", "Poland") & Date>"2020-09-30" & Date<"2020-12-01")
# find the date that each country tightened their stay-at-home order
ind = home %>% group_by(Entity) %>% mutate(change= stay_home_requirements-lag(stay_home_requirements,1))
start_date = ind[which(ind$change!=0),]

# response variable_by_days_since_policy_started
covid_new_d7 = covid_model.d7
# the date that stay-at-home order was tightened
policy_start = rep(0,dim(covid_new_d7)[1]) 
policy_start[which(covid_new_d7$Country=="France")] = "2020-10-17" 
policy_start[which(covid_new_d7$Country=="Germany")] = "2020-10-15" 
policy_start[which(covid_new_d7$Country=="Italy")] = "2020-10-23"
policy_start[which(covid_new_d7$Country=="Poland")] = "2020-10-24"
policy_start[which(covid_new_d7$Country=="UK")] = "2020-10-23"
covid_new_d7$policy_start = as.Date(policy_start)
covid_new_d7$Date_reported = as.Date(covid_new_d7$Date_reported)
# number of days prior to or after policy issued
days_since_start = rep(0, dim(covid_new_d7)[1])
days_since_start = covid_new_d7$Date_reported - covid_new_d7$policy_start
covid_new_d7$days_since_start = days_since_start
# new rsponse dataset by days since policy started
covid_by_days = covid_new_d7[which(covid_new_d7$days_since_start>-15 & covid_new_d7$days_since_start<29),]
```

```{r by-days plot, fig.height=4, fig.width=10}
# plots of growth of infectious population vs. days since order started
covid_by_days$days_since_start <- as.factor(covid_by_days$days_since_start)
infection_country_bydays = covid_by_days %>% ggplot(aes(x=days_since_start,y=delta_infec_07ma, group=Country,color=Country))+geom_line()+labs(x = "Days since start of stay-at-home order", y = "Growth rate of infectous population")+ggtitle("Growth rate of infectious population before and after the start of stay-at-home order") +theme(plot.title = element_text(size = 11,face = "bold"),legend.text = element_text(size=10))
ggplotly(infection_country_bydays,tooltip = c("x","colour","y"))
```
### Model justification
As observed in the world trend of daily cases of Covid-19, there was a peak between October and November in many countries, including the five European countries that we focused on in this project. In response to such skyrocketing numbers of cases, all five contries issued stay-at-home orders around that period of time in hope to contain the spread of Covid-19. It was also noticed that there was a delay between the order starting date and the date when daily new cases began to decrease, which was expected since most of policies would have a lagged effect. _In order to understand the temporal dynamics of the stay-at-home order, we measured the policy effects on growth rate of infectious population as a function of time since the order started._ Number of days since the order started was treated as a categorical variable with each day as a level. We looked at the period of 14 days before and 28 days after the order came into effect. The estiamted coefficients could be considered as the change in infectious population growth rate due to the stay-at-home order without varying implementation time.

A fixed effect regression model was constructed. One advantage of this model is that it controls for unobserved country-specific factors that were not included as predictors.This model is equivalent to a difference-in-difference model with variation in treatment time.

### Model setup and parameter notation
An one-way fixed effect regression model was defined as: $$Y_{ct} = \beta_c + \sum_{\tau \neq -1}\beta_\tau X_{ct\tau}+\epsilon_{ct}$$

**Parameter notation** <br>

* $Y_{ct}$ is the response variable: % growth rate in infectous population of country c at time t.

* $\beta_c$ is the counry-specific, time-invariant fixed factor for country c.

* $\tau$ is the number of days prior to or after the stay-at-home order was issued. 

* $\beta_\tau$ is the effect size of the policy on the growth rate of infectious population $\tau$ days before/after the policy started. 

* $X_{ct\tau}$ are dummpy variables indicating whether day t is the $\tau$ day before or after policy started in country c. 

**Assumptions** <br>

* Conditional relationship of $Y_{ct}$ given $X_{ct\tau}$ is linear in the explanatory variables.

* $\epsilon_{ct}$ are independent random variables with zero mean and constant variance: $$E(\epsilon_{it})=0,\  Var(\epsilon_{it})=\sigma^2$$

**Hypothesis** <br>

* $H_0:$ all $\beta_\tau = 0$ vs. $H_a:$ not all $\beta_\tau = 0$

### Model fitting results
```{r model fitting, include = FALSE}
covid_by_days$days_since_start <- relevel(covid_by_days$days_since_start,ref = "-1")

# OLS model
ols <- lm(delta_infec_07ma~days_since_start,data = covid_by_days)
# country-fixed effect model
country_plm <- plm(delta_infec_07ma~days_since_start,data = covid_by_days,index = c("Country","days_since_start"), model = "within")
# confidence interval for each coefficient
coef = country_plm$coefficients
se = sqrt(diag(country_plm$vcov))
alpha = 0.05
t_stat = qt(1-alpha/2, country_plm$df.residual,lower.tail = FALSE)
CI_lower = coef - t_stat*se
CI_upper = coef + t_stat*se
inference <- data.frame(Days_since_start = c(-14:-2,0:28), Estimate = coef, CI_lower = CI_lower, CI_upper = CI_upper)

summary = inference[14:42,]
summary$CI_lower = round(summary$CI_lower,digits = 2); summary$CI_upper = round(summary$CI_upper,digits = 2); summary$Estimate = round(summary$Estimate,digits=2)

# R2 and Ra2
n = dim(covid_by_days)[1]
sst = with(covid_by_days, sum((delta_infec_07ma-mean(delta_infec_07ma))^2))
sse = sum(residuals(country_plm)^2)
R2 = 1 - sse/sst
Ra2 = 1- (1-R2)*(n-1)/(n-length(coef(country_plm))-1)
```

**Table 1** summarized the coefficient estimates and their 95% confidence intervals for 0 ~ 28 days after the policy started, which could be interpreted as the effect of different implemetation date on growth rate of infectious population. Negative values indicated that the growth rate of infectious population was slowing down. As shown in the table, the effect of stay-at-home order on flattering the curve started to become significant (p<0.05) at day 13 after it was first implemented. The figure below visualized the effect of stay-at-home order before and after it was implemented. The days prior to policy implementation was also included in the model to test for any reversed causal effect. The figure showed that the coefficients estimates before the policy started were not significantly different from zero, confirming that the growth rate in infectiou population did not affect the policy starting date.

```{r model results, fig.height=4,fig.width = 10, warning = FALSE}
# table of beta estimates and ci 
kable(summary,row.names = FALSE,align = "c", caption = "Table 1: Coefficient estimates from regression of daily growth rate of Covid-19 infectious population on number of days since stay-at-home order") 

# plot coefficient estimates and confidence bands
ggplot(inference, aes(x=Days_since_start,y=Estimate)) + 
  geom_line() + geom_point() + 
  geom_ribbon(mapping = aes(ymin = CI_lower, ymax = CI_upper),alpha = 0.4) + 
  labs(x = "Days since stay-at-home order",y = "\u0394 Growth in infectious population")+ ggtitle("Change in growth rate of infectious population with varying implementation time of stay-at-home order") + theme(plot.title = element_text(size = 12, face="bold")) +
  geom_vline(xintercept = c(0,13), linetype = "dashed",color = "red")
```
* The dashed red lines dictated D-day of the policy and 13 days after its implementation when its effect on reducing growth rate of infectious population firstly became significant.

## Effect of policy strictness on infectious population growth rate

# Sensitivity analysis 

## Lagged effect of stay-at-home order 
```{r, include = FALSE}
## model justification
# test for individual effect
plm_pooling = plm(delta_infec_07ma~days_since_start,data = covid_by_days,index = c("Country","days_since_start"), model = "pooling")
pFtest(country_plm, plm_pooling) #-------- p<2.2e-16, indicating significant individual effect
```

First, the necessity of adopting a individual fixed effect model was tested by comparing the current model with a pooling model where all countries' data were pooled together. The null hypothesis that the two models are indistinguishable was rejected (p<0.05), indicating that it was necessary to use a fixed effect model accounting for country-specific factors.

The diagnostics plots below tested the homocedasticity and normality assumption, as well as the presence of outliers. The residuals vs. fitted value plot showed that the residuals were mostly evenly distributed around zero but with a slightly quadratic pattern. QQ plot confirmed the normality assumption was fulfilled. And the Cook's plot showed that no observation had cook's distance larger than 1, indicating that there was no influential cases.

```{r,warning=FALSE}
## model diagnostics
###### Test for homoscedasticity ######
par(mfrow=c(2,2),oma=c(0,0,2,0))
fitted <- as.numeric(covid_by_days$delta_infec_07ma - residuals(country_plm))
# residual vs. fitted plot
plot(fitted,residuals(country_plm),bty='n',xlab='Fitted values', ylab='Residuals',main='Residuals vs. Fitted values')
lines(smooth.spline(fitted,residuals(country_plm), spar=1.3), col=2)
abline(h=0,col='red',lty='dashed')

###### Test for normality #######
qqnorm(residuals(country_plm), main = "QQ plot of residuals")
qqline(residuals(country_plm), col = "red")
###### Cook's distance ######
x.tmp <- diag(1,43,43)
x.tmp[14,14] = 0
x.tmp <-  x.tmp[,-14]
X <- rbind(x.tmp,x.tmp,x.tmp,x.tmp,x.tmp)
H <- X %*% solve(t(X) %*% X) %*% t(X)
cooks = residuals(country_plm)^2/length(coef(country_plm))* diag(H)/(1-diag(H))
plot(names(cooks),cooks,type = "h", xlab="Index",ylab = "Cook's distance", main = "Cook's distance")
points(names(cooks),cooks,cex=0.3)
title(main = "Diagnostics plots", outer=TRUE)
par(mfrow=c(1,1))
```

## Effect of policy strictness on infectious population growth rate


# Causal interpretation 


# Discussion 


# Acknowledgement {-}


# Reference {-}


# Session info {-}

<span style='color:blue'>
Report information of your `R` session for reproducibility. 
</span> 


```{r}
sessionInfo()
```